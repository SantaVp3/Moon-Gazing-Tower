# 节点管理 (Node Management)

为了应对大规模资产扫描的需求，Moon-Gazing-Tower 支持分布式部署。节点管理模块用于管理和监控所有的扫描节点。

## 节点架构

系统采用 **Master-Worker** 架构：
- **Master (控制中心)**: 负责任务调度、结果汇总、用户交互。
- **Worker (扫描节点)**: 负责执行具体的扫描任务。

## 功能特性

### 1. 节点注册
新节点启动后，会自动向 Master 注册。
- **自动发现**: 节点启动时自动上报 IP、端口、版本等信息。
- **能力汇报**: 节点会汇报自身支持的扫描能力（如是否安装了 Chrome 用于爬虫）。
- **心跳机制**: 节点定期发送心跳包，维持在线状态。

### 2. 状态监控
实时监控所有节点的运行状态：
- **在线/离线**: 快速识别故障节点。
- **负载监控**: 查看 CPU、内存使用率。
- **任务统计**: 当前正在执行的任务数、已完成任务数。

### 3. 任务分发
Master 根据节点的负载和能力进行智能调度：
- **负载均衡**: 将任务优先分发给空闲节点。
- **能力匹配**: 将爬虫任务分发给安装了浏览器的节点。
- **就近调度**: (规划中) 根据网络距离调度节点。

### 4. 节点配置
- **最大并发数**: 限制每个节点同时执行的任务数量。
- **启用/禁用**: 临时停用某个节点进行维护。
- **标签管理**: 为节点打标签（如 `high-performance`, `overseas`），用于指定任务运行节点。

## 部署节点

### Docker 部署 (推荐)

```bash
docker run -d \
  --name moon-worker \
  -e MASTER_URL=http://master-ip:8080 \
  -e NODE_TOKEN=your-token \
  moon-gazing-tower/worker:latest
```

### 手动部署

1. 下载 Worker 二进制文件。
2. 配置 `config.yaml`：
   ```yaml
   master:
     url: "http://localhost:8080"
     token: "your-token"
   node:
     max_tasks: 5
   ```
3. 启动服务：
   ```bash
   ./worker
   ```

## 故障处理

- **节点离线**: 超过一定时间未收到心跳，Master 会将节点标记为离线，并重新分发其未完成的任务。
- **任务超时**: 节点执行任务超时，Master 会强制终止并重试。
