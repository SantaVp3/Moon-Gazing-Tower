# 任务队列 (Task Queue)

Moon-Gazing-Tower 使用基于 Redis 的分布式任务队列来管理海量的扫描任务，确保系统的高并发和高可用。

## 队列架构

系统将不同类型的任务分配到不同的队列中，实现资源隔离和优先级控制。

### 队列类型

1. **普通队列 (Normal Queue)**
   - 处理常规的扫描任务。
   - 默认优先级。

2. **高优先队列 (High Priority Queue)**
   - 处理用户手动触发的紧急任务。
   - 优先被 Worker 消费。

3. **慢速队列 (Slow Queue)**
   - 处理耗时较长的任务（如全端口扫描、深度爬虫）。
   - 避免阻塞其他快速任务。

4. **死信队列 (Dead Letter Queue)**
   - 存储执行失败且重试次数耗尽的任务。
   - 供管理员排查问题。

## 队列管理功能

### 1. 队列监控
实时查看各队列的状态：
- **待处理任务数**: 当前排队等待执行的任务数量。
- **处理中任务数**: 正在执行的任务数量。
- **积压情况**: 监控队列是否出现严重积压。

### 2. 任务控制
- **暂停/恢复**: 暂停某个队列的消费，用于系统维护或紧急避险。
- **清空队列**: 清除队列中的所有积压任务。
- **重试死信**: 将死信队列中的任务重新投入运行队列。

### 3. 优先级调整
- 支持动态调整任务的优先级，将重要任务插队执行。

## 技术实现

- **Redis List/Stream**: 作为底层存储结构。
- **原子操作**: 保证任务状态流转的一致性。
- **ACK 机制**: 只有任务执行成功并确认后，才从队列中移除，防止任务丢失。

## 配置优化

在 `config.yaml` 中可以调整队列相关的参数：

```yaml
queue:
  redis:
    host: "localhost"
    port: 6379
  
  # 队列容量限制
  max_size: 10000
  
  # 任务超时时间
  task_timeout: 3600 # 秒
  
  # 最大重试次数
  max_retries: 3
```

## 常见问题

**Q: 队列积压严重怎么办？**
A: 
1. 增加 Worker 节点数量。
2. 检查是否有异常耗时的任务阻塞了队列。
3. 临时暂停非紧急任务的提交。

**Q: 任务执行失败会怎样？**
A: 系统会自动重试（默认 3 次）。如果依然失败，任务会被移动到死信队列，并记录错误日志。
