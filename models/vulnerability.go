package models

import (
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
)

// VulnSeverity represents vulnerability severity levels
type VulnSeverity string

const (
	VulnSeverityCritical VulnSeverity = "critical"
	VulnSeverityHigh     VulnSeverity = "high"
	VulnSeverityMedium   VulnSeverity = "medium"
	VulnSeverityLow      VulnSeverity = "low"
	VulnSeverityInfo     VulnSeverity = "info"
)

// VulnStatus represents vulnerability status
type VulnStatus string

const (
	VulnStatusNew       VulnStatus = "new"
	VulnStatusConfirmed VulnStatus = "confirmed"
	VulnStatusFixed     VulnStatus = "fixed"
	VulnStatusIgnored   VulnStatus = "ignored"
	VulnStatusFalse     VulnStatus = "false_positive"
)

// Vulnerability represents a discovered vulnerability
type Vulnerability struct {
	ID           primitive.ObjectID `json:"id" bson:"_id,omitempty"`
	WorkspaceID  primitive.ObjectID `json:"workspace_id" bson:"workspace_id"`
	AssetID      primitive.ObjectID `json:"asset_id" bson:"asset_id"`
	TaskID       primitive.ObjectID `json:"task_id" bson:"task_id"`
	
	// Basic Info
	Name         string       `json:"name" bson:"name"`
	Description  string       `json:"description" bson:"description"`
	Severity     VulnSeverity `json:"severity" bson:"severity"`
	Status       VulnStatus   `json:"status" bson:"status"`
	
	// Technical Details
	Type         string   `json:"type" bson:"type"` // sqli, xss, rce, etc.
	TemplateID   string   `json:"template_id" bson:"template_id"` // Nuclei template ID
	Target       string   `json:"target" bson:"target"` // URL, IP:Port
	Method       string   `json:"method" bson:"method"` // GET, POST
	Payload      string   `json:"payload" bson:"payload"`
	Evidence     string   `json:"evidence" bson:"evidence"`
	Request      string   `json:"request" bson:"request"`
	Response     string   `json:"response" bson:"response"`
	
	// Reference
	CVEID        []string `json:"cve_id" bson:"cve_id"`
	CNNVDID      []string `json:"cnnvd_id" bson:"cnnvd_id"`
	References   []string `json:"references" bson:"references"`
	
	// POC Info
	POCID        primitive.ObjectID `json:"poc_id" bson:"poc_id"`
	POCName      string             `json:"poc_name" bson:"poc_name"`
	
	// Remediation
	Solution     string    `json:"solution" bson:"solution"`
	FixedAt      time.Time `json:"fixed_at,omitempty" bson:"fixed_at,omitempty"`
	FixedBy      string    `json:"fixed_by,omitempty" bson:"fixed_by,omitempty"`
	
	// Verification
	LastVerifiedAt time.Time `json:"last_verified_at,omitempty" bson:"last_verified_at,omitempty"`
	
	// Metadata
	Scanner      string    `json:"scanner" bson:"scanner"` // nuclei, xray, custom
	Tags         []string  `json:"tags" bson:"tags"`
	CreatedAt    time.Time `json:"created_at" bson:"created_at"`
	UpdatedAt    time.Time `json:"updated_at" bson:"updated_at"`
}

// POC represents Proof of Concept for vulnerability detection
type POC struct {
	ID          primitive.ObjectID `json:"id" bson:"_id,omitempty"`
	TemplateID  string             `json:"template_id" bson:"template_id"` // Nuclei template ID for deduplication
	Name        string             `json:"name" bson:"name"`
	Description string             `json:"description" bson:"description"`
	Author      string             `json:"author" bson:"author"`
	Severity    VulnSeverity       `json:"severity" bson:"severity"`
	Type        string             `json:"type" bson:"type"` // nuclei, xray, custom
	Tags        []string           `json:"tags" bson:"tags"`
	
	// POC Content
	Content     string `json:"content" bson:"content"` // YAML content for nuclei
	
	// Reference
	CVEID       []string `json:"cve_id" bson:"cve_id"`
	References  []string `json:"references" bson:"references"`
	
	// Metadata
	Enabled     bool      `json:"enabled" bson:"enabled"`
	Version     string    `json:"version" bson:"version"`
	Source      string    `json:"source" bson:"source"` // official, community, custom
	CreatedAt   time.Time `json:"created_at" bson:"created_at"`
	UpdatedAt   time.Time `json:"updated_at" bson:"updated_at"`
}

// VulnReport represents vulnerability report
type VulnReport struct {
	ID          primitive.ObjectID `json:"id" bson:"_id,omitempty"`
	WorkspaceID primitive.ObjectID `json:"workspace_id" bson:"workspace_id"`
	Name        string             `json:"name" bson:"name"`
	Type        string             `json:"type" bson:"type"` // pdf, html, excel
	
	// Report Content
	Summary     ReportSummary `json:"summary" bson:"summary"`
	FilePath    string        `json:"file_path" bson:"file_path"`
	
	// Metadata
	CreatedBy   primitive.ObjectID `json:"created_by" bson:"created_by"`
	CreatedAt   time.Time          `json:"created_at" bson:"created_at"`
}

// ReportSummary represents report summary statistics
type ReportSummary struct {
	TotalAssets      int `json:"total_assets" bson:"total_assets"`
	TotalVulns       int `json:"total_vulns" bson:"total_vulns"`
	CriticalCount    int `json:"critical_count" bson:"critical_count"`
	HighCount        int `json:"high_count" bson:"high_count"`
	MediumCount      int `json:"medium_count" bson:"medium_count"`
	LowCount         int `json:"low_count" bson:"low_count"`
	InfoCount        int `json:"info_count" bson:"info_count"`
}

// Collection names for vulnerabilities
const (
	CollectionVulnerabilities = "vulnerabilities"
	CollectionPOCs            = "pocs"
	CollectionVulnReports     = "vuln_reports"
)
